name: Deploy

on: 
    pull_request:
        branches:
            - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    container:
      image: python:3.12
      
    steps:
      - uses: actions/checkout@v3
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Deploy to Render
        run: |
          curl -X POST "https://api.render.com/v1/services/${{ secrets.SERVICE_ID }}/deploys" \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
          -H "Accept: application/json" \
          -H "Content-Type: application/json" \
          -d '{}'

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ec2-user
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Install necessary dependencies
            sudo yum install -y git
            sudo yum install -y nginx

            # Create project directory structure
            mkdir -p /home/ec2-user/fastapi-book-project
            cd /home/ec2-user/fastapi-book-project
            
            # Clone/pull repository
            if [ -d ".git" ]; then
              git pull origin main
            else
              git clone https://github.com/ObinnaVic/fastapi-book-project .
            fi
            
            # Set up Python virtual environment
            python3 -m venv venv
            source venv/bin/activate
            pip install -r requirements.txt
            
            # Update systemd service file with correct paths
            sudo tee /etc/systemd/system/fastapi.service << EOF
            [Unit]
            Description=FastAPI application
            After=network.target

            [Service]
            User=ec2-user
            WorkingDirectory=/home/ec2-user/fastapi-book-project
            ExecStart=/home/ec2-user/fastapi-book-project/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000
            Restart=always

            [Install]
            WantedBy=multi-user.target
            EOF
            
            # Reload and restart services
            sudo systemctl daemon-reload
            sudo systemctl enable fastapi
            sudo systemctl restart fastapi
            sudo systemctl restart nginx







            # cd /home/victor-nkire/Desktop/fastapi-book-project
            # git pull origin main
            # source venv/bin/activate
            # pip install -r requirements.txt
            # sudo systemctl restart fastapi
            # sudo systemctl restart nginx


          